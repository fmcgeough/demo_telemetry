# DemoTelemetry

This is a github repo I setup to demonstrate telemetry event generation for the
[Elixir](https://elixir-lang.org/) language's [ecto library](https://hexdocs.pm/ecto/Ecto.html).

Note: this demonstrates a number of aspects of Ecto Telemetry. It's fine to submit a PR for this
repo if you want to add to what is demonstrated (or fix some problem).

See the blog post [Ecto Telemetry](https://fmcgeough.github.io/blog/2024/ecto-telemetry/) for more information.

## Demonstrating Ecto Telemetry

The code in this app demonstrates some features of ecto telemetry that you should
be aware of. You can try out these features in iex. You need to have a Postgresql
test instance that the code can connect to. You will want to modify the connection
information in the `config/config.exs` file. Here are steps to get going:

```
$ git clone https://github.com/fmcgeough/demo_telemetry
$ cd demo_telemetry
$ mix deps.get
$ mix ecto.create
$ mix ecto.migrate
$ iex -S mix
```

You can follow along after that with the sections below.

## Simple Tests

This shows the event data (including the event name) received when
interacting with each of the three repos defined in the project.

```
$ iex -S mix
iex> DemoTelemetry.Database.Repo.all(User)
```
![Primary](guides/primary.png)

```
iex> DemoTelemetry.Database.ReaderRepo.all(User)
```
![Replica](guides/replica.png)

```
iex> DemoTelemetry.Database.OtherRepo.all(User)
```
![Other](guides/other.png)

## Transactions and Ecto.Multi

```
iex> alias Ecto.Multi
iex> Multi.new() |> Multi.run(:test, fn _repo, _args -> {:ok, nil} end) |> Repo.transaction()
```

![Multi](guides/multi_commit.png)

```
iex> alias Ecto.Multi
iex> Multi.new() |> Multi.run(:test, fn _repo, _args -> {:error, :badness} end) |> Repo.transaction()
```

![Multi](guides/multi_rollback.png)

## Identify Your Query

When you execute your query you can pass in telemetry_options as a final parameter. This lets
you pass on important information to your metrics handler. It's very important to do so. It
allows you to easily identify what SQL was executed (without attempting to parse the query
passed in the metadata). Note that transaction related operations - begin, commit, rollback - cannot
be named in this way. You will need to explicitly look for those strings in order to identify
them in your metrics.

iex> Repo.all(User, telemetry_options: %{name: "all_users"})

![Query Id](guides/query_id.png)

## Telemetry Event

Another option available is to use `:telemetry_event` when the database operation is done.
Personally I've never used this but it is available. The event generated by ecto_sql uses
the exact name that you pass as the `:telemetry_event` (it doesn't append `[:query]` to the
event name). That means that if you want to receive the event you must include the name
in the list of events you're listening for in call to `:telemetry.attach_many`.

Here's an example using `:telemetry_event`.

```
iex> Repo.all(User, telemetry_event: [:demo_telemetry, :test_telemetry_event])
```

The generated event name will be: `[:demo_telemetry, :test_telemetry_event]`.

![Telemetry Event](guides/telemetry_event.png)
